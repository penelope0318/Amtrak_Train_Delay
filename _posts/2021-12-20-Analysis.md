---
title: "Exploratory Analysis"
date: 2021-12-20
published: true
tags: [dataviz, altair, folium]
excerpt: "Exploratory Analysis of the data."
altair-loader:
  altair-chart-1: "charts/station_time_heatmap.json"
  altair-chart-2: "charts/weekday_time_alt.json"
  altair-chart-3: "charts/station_lag_alt.json"
  altair-chart-4: "charts/station_time_heatmap1.json"
folium-loader:
  folium-chart-1: ["charts/foliumChart.html", "500"]
  folium-chart-2: ["charts/line_foliumChart.html", "500"]
toc: true
toc_sticky: true
---
![NJ_Transit_Amtrak](https://raw.githubusercontent.com/penelope0318/Amtrak_Train_Delay/master/assets/images/us_njtransit_nec.jpeg)

## 0. Data Preparation
-------- 尝试加表格
Here is a glimpse of the original dataset from <a href="https://www.kaggle.com/pranavbadami/nj-transit-amtrak-nec-performance?select=2018_11.csv">Kaggle</a>. We selected the data in 11/2019 and 12/2019, totaling 682,163 rows. To clean the data, we dropped any rows with NA values in the `scheduled_time`, `delay_minutes`, `from_id`, `to_id` columns. Additionally, in order to focus on the issue of punctuality , we decided to drop any records labelled as `cancelation`, as this is distinct from the issue of delay in some extent. The final cleaned dataset has 436,100 records in total. To gain a geographical perspective on the delay, the dataset was combined with the stations' location data from <a href="https://github.com/pranavbadami/njtransit">Pranav Badami</a>. 



## 1. Statistic Summary 

These histograms illustrate the substantially left-skewed distribution of train delays in NJ transit's commute rail services in 2019 November and December. The bulk of the delay (97% ）events was spaned from **0 min to 20 min**, however, there is an extremely long tail in the data, which reveals that approximately 50 travels (0.016%) are suffering from more than 100 minutes delay.
![delay_distribution](https://raw.githubusercontent.com/penelope0318/Amtrak_Train_Delay/master/assets/images/delay_distribution.png)
-----------------标记median num

As delays can happen for a variety of reasons, the following parts will focus on the analysis about when and where did the delay typically happen.




## 2. Analysis Delay by Time

It's known that delay is highly related to date and time, rider's travel behavior and train schedule varied according to weekday, time of the day and holidays. The following diagram plots the train volume by `scheduled arrive time` (the bars), as well as the average delay minutes by `scheduled arrive time` and `the departure weekday` (the series lines). 

It demonstrates that NJ transit rail services's rush hours are mostly around 6am-10am and 3pm-8pm. The series lines indicate that the heavy delay usually happened around 6pm-7:30pm of the day, and considering the train volume, the most severe dealy occurs on **Saturday 8pm-9pm** where trains were delayed for an average of 8 minutes. 
<div id="altair-chart-2"></div>
<br> 


However, NJ Transit operates 166 stations in total <a href="https://www.njtransit.com/press-releases/nj-transit-named-one-years-americas-best-employers-forbes">(NJ Transit, 2021)</a>., did the train usually delay in the same pattern for all stations? The answer is no. The subsequent section will analyze the delay by station.


## 3. Analysis Delay by Location 

### 1) Stations 
To put the delay in geographical context, we plotted the train volume **(circle size)** and average delay minutes **(color)** map by different stations in the following map. You can click each circle to get detailed information.  Through this map, we found that New York Penn Station (NY),  Newark Penn Station (NJ), Secaucus Upper Lvl (NJ), Hoboken (NJ), Princeton Junction (NJ) are the top 5 largest stations in the NJ Transit network by train volume, and they all performed better than the NJ Transit's average in terms of the average delay minutes (NJ Transit's average is 5.2min).
<div id="folium-chart-1"></div>
<br> 

Certain stations like Clifton (NJ) and Passaic (NJ) have an average 18-minutes delay of around 1pm, while Denville (NJ) and Philadephia (PA) experienced more than 1-hour severe delay around 1am on average, which is obviously different from other stations! 
<div id="altair-chart-1"></div>
<br> 

To better understand the severe delay (>=10min), we also plotted a severity matrix that counts the number of severe delay events by stations and scheduled departure hour. It reveals that New York Penn Station (NY), Newark Penn Station (NJ), Hoboken (NJ), and Secaucus Upper Lvl (NJ) are the stations that have undergone many severe delays throughout the whole day, which might be attributed to the train volume of the busy stations. Although these stations have an acceptable average delay time as the last matrix shows, for example, New York Penn Station's average delay time during rush hour is only 4 min, given the stations' massive rider base, the high frequency of severe delay incidents also requires further attention.
<div id="altair-chart-4"></div>
<br> 

### 2) Lines
NJ Transit now operates 11 commuter train lines, largely in northern New Jersey linked to New York City, as well as one route connecting Atlantic City and Philadelphia. They are operated by different divisions and employ a variety of different train types, thus it's likely that the delay pattern changed according to line. The following map demonstrates the average delay minutes (circle size) and lines (color) of the station, which shows that the **Atlantic City Line** suffered substantial severe delay compared with all other lines. Each station on the Atlantic City Line has an average delay duration that is four times that of all other stations (which is 4.4 min).

![line_legend](https://raw.githubusercontent.com/penelope0318/Amtrak_Train_Delay/master/assets/images/line_legend.jpg)
<div id="folium-chart-2"></div>

### 3) Station Lag
Apart from that, we also select the previous station's delay time in the same line in the last three hours and 30 minutes as station lag features to study the train's historical situation of delay. In general, if a train is delayed at one stop, it is quite likely that it will be late at the next station, and the delay time will also accumulate. The following scatter plot justifies this idea.  However, if the interval between two stations is too long, then it's possible that the delay will be less impacted by the previous trip since the operator has enough time to adjust the speed. Therefore, for this feature, we limited the time interval to 3 hours or 30 minutes to see the correlation between the stops and its previous stop. 
<div id="altair-chart-3"></div>




## 4. Analysis Delay by Weather

![weather_bar](https://raw.githubusercontent.com/penelope0318/Amtrak_Train_Delay/master/assets/images/weather_bar.png)

![weather_line](https://raw.githubusercontent.com/penelope0318/Amtrak_Train_Delay/master/assets/images/weather_line.png)


